# ZIM setup

ZIM_HOME=${XDG_CACHE_HOME}/zim
# Download zimfw plugin manager if missing.
if [[ ! -e ${ZIM_HOME}/zimfw.zsh ]]; then
  curl -fsSL --create-dirs -o ${ZIM_HOME}/zimfw.zsh \
      https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
fi

source ${ZIM_HOME}/init.zsh

# Install missing modules, and update ${ZIM_HOME}/init.zsh if missing or outdated.
if [[ ! ${ZIM_HOME}/init.zsh -nt ${ZDOTDIR:-${HOME}}/.zimrc ]]; then
  source ${ZIM_HOME}/zimfw.zsh init -q
fi

#Guix

export GUIX_EXTRA_PROFILES=$HOME/.guix-extra-profiles

for i in $GUIX_EXTRA_PROFILES/*; do
    profile=$i
    if [ -f "$profile"/etc/profile ]; then
        GUIX_PROFILE="$profile"
        . "$GUIX_PROFILE"/etc/profile
    fi
    unset profile
done

# bat as manpage
export MANPAGER="sh -c 'col -bx | bat -l man -p'"


# other
source $HOME/.config/zsh/work/work.zsh
source $HOME/.config/zsh/work/secrets.zsh

FPATH=$ZDOTDIR/completions:$FPATH

source $HOME/.config/zsh/fzf/fzf.sh


if command -v fnm &> /dev/null
then
  eval "$(fnm env --use-on-cd)"
fi

if command -v zoxide &> /dev/null
then
  eval "$(zoxide init --cmd j zsh)"
fi

export PYENV_ROOT=${XDG_CACHE_HOME}/pyenv
export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init --path)"

if command -v pyenv >/dev/null; then eval "$(pyenv init -)"; fi

# This script was automatically generated by the broot program
# More information can be found in https://github.com/Canop/broot
# This function starts broot and executes the command
# it produces, if any.
# It's needed because some shell commands, like `cd`,
# have no useful effect if executed in a subshell.
function br {
    local cmd cmd_file code
    cmd_file=$(mktemp)
    if broot --outcmd "$cmd_file" "$@"; then
        cmd=$(<"$cmd_file")
        rm -f "$cmd_file"
        eval "$cmd"
    else
        code=$?
        rm -f "$cmd_file"
        return "$code"
    fi
}


function set_aws_keys {
  export AWS_ACCESS_KEY_ID=$1
  export AWS_SECRET_ACCESS_KEY=$2
  if [[ $# > 2 ]]
  then
    export AWS_SESSION_TOKEN=$3
  fi
}

export DOOMDIR='~/data/personal/doom.d/'
export PATH="$PATH:$HOME/.dotfiles/doom-emacs/bin"
export VISUAL='emacsclient -c -t'
export EDITOR='emacsclient -c -t'

# edit line in editor
autoload -U edit-command-line
# Emacs style
zle -N edit-command-line
bindkey '^xe' edit-command-line
bindkey '^x^e' edit-command-line

VM_FOLDER=~/data/vm
function vm {
  cd $VM_FOLDER
  find $VM_FOLDER -name '*.conf' | fzf | xargs -I {} quickemu --vm {} --display spice
  cd -
}

#alias
alias gs="git status"

eval "$(starship init zsh)"
